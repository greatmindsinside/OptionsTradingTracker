<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Portfolio Persistence</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
    </style>
</head>
<body>
    <h1>Portfolio Persistence Test</h1>
    
    <div class="test-section">
        <h2>Database Operations</h2>
        <button onclick="testDatabaseInit()">1. Initialize Database</button>
        <button onclick="testCreatePortfolio()">2. Create Portfolio</button>
        <button onclick="testPersistData()">3. Persist to Storage</button>
        <button onclick="testVerifyPortfolio()">4. Verify Portfolio Exists</button>
        <button onclick="clearAll()">Clear All</button>
        <div id="results"></div>
    </div>

    <script type="module">
        let db = null;
        let portfolioDAO = null;

        window.testDatabaseInit = async function() {
            try {
                const { initDatabase } = await import('./src/modules/db/sqlite.ts');
                db = await initDatabase();
                addResult('‚úÖ Database initialized successfully');
                
                const { PortfolioDAO } = await import('./src/modules/db/dao/PortfolioDAO.ts');
                portfolioDAO = new PortfolioDAO(db);
                addResult('‚úÖ PortfolioDAO created');
            } catch (error) {
                addResult('‚ùå Database init failed: ' + error.message);
            }
        };

        window.testCreatePortfolio = async function() {
            if (!portfolioDAO) {
                addResult('‚ùå Database not initialized. Run step 1 first.');
                return;
            }

            try {
                const portfolioId = await portfolioDAO.create({
                    name: 'Test Portfolio ' + Date.now(),
                    description: 'Test portfolio for persistence verification',
                    broker: 'test_broker',
                    created_at: new Date().toISOString()
                });
                
                window.testPortfolioId = portfolioId;
                addResult('‚úÖ Portfolio created with ID: ' + portfolioId);
                
                // Verify it exists in memory
                const portfolio = await portfolioDAO.findById(portfolioId);
                if (portfolio) {
                    addResult('‚úÖ Portfolio found in memory: ' + portfolio.name);
                } else {
                    addResult('‚ùå Portfolio not found in memory after creation');
                }
            } catch (error) {
                addResult('‚ùå Portfolio creation failed: ' + error.message);
            }
        };

        window.testPersistData = async function() {
            if (!db) {
                addResult('‚ùå Database not initialized. Run step 1 first.');
                return;
            }

            try {
                addResult('üîÑ Persisting data to storage...');
                await db.persist();
                addResult('‚úÖ Data persisted to storage successfully');
            } catch (error) {
                addResult('‚ùå Persist failed: ' + error.message);
            }
        };

        window.testVerifyPortfolio = async function() {
            if (!portfolioDAO || !window.testPortfolioId) {
                addResult('‚ùå No portfolio to verify. Run steps 1-3 first.');
                return;
            }

            try {
                // Check if portfolio still exists
                const portfolio = await portfolioDAO.findById(window.testPortfolioId);
                if (portfolio) {
                    addResult('‚úÖ Portfolio verified after persist: ' + portfolio.name);
                    
                    // List all portfolios to see what's in storage
                    const allPortfolios = await portfolioDAO.findAll();
                    addResult('üìã Total portfolios in database: ' + allPortfolios.length);
                    allPortfolios.forEach(p => {
                        addResult('   - Portfolio: ' + p.name + ' (ID: ' + p.id + ')');
                    });
                } else {
                    addResult('‚ùå Portfolio not found after persist');
                }
            } catch (error) {
                addResult('‚ùå Verification failed: ' + error.message);
            }
        };

        window.clearAll = function() {
            document.getElementById('results').innerHTML = '';
            db = null;
            portfolioDAO = null;
            window.testPortfolioId = null;
        };

        function addResult(message) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = 'result';
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        // Auto-start test
        addResult('üöÄ Test page loaded. Click "1. Initialize Database" to start.');
    </script>
</body>
</html>